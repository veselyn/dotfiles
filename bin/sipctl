#!/usr/bin/env bash

set -euo pipefail

function main() {
	local command=$1

	case "$command" in
	disable)
		if [[ $__OSINSTALL_ENVIRONMENT == 1 ]]; then
			csrutil enable --without fs --without debug --without nvram
		else
			nvram boot-args=-arm64e_preview_abi
		fi
		;;
	enable)
		if [[ $__OSINSTALL_ENVIRONMENT == 1 ]]; then
			csrutil enable
		else
			nvram -d boot-args
		fi
		;;
	status)
		csrutil status
		set +e
		nvram boot-args
		set -e
		;;
	*)
		echo >&2 'unknown command'
		return 1
		;;
	esac
}

if [[ "${BASH_SOURCE[0]}" == "$0" ]]; then
	main "$@"
fi
